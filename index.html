<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Cuban-Store | Premium Quality</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-YK3NZLGRLW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-YK3NZLGRLW');
  </script>
  <style>
    :root {
      --primary: #09090B;      /* Negro Zinc profundo */
      --secondary: #18181B;    /* Gris oscuro para tarjetas */
      --accent: #D4AF37;       /* Dorado Met√°lico */
      --accent-hover: #F1C40F; /* Dorado brillante */
      --bg-site: #020617;      /* Fondo ultra oscuro */
      --text-main: #FAFAFA;
      --text-muted: #A1A1AA;
      --border: #27272A;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      --transition: all 0.3s ease;
      --error: #EF4444;        /* Rojo Alerta */
    }

    * { box-sizing: border-box; }
    body { 
      font-family: 'Inter', -apple-system, sans-serif; 
      margin: 0; background-color: var(--bg-site); color: var(--text-main);
      -webkit-tap-highlight-color: transparent;
      padding-bottom: 80px; 
    }

    /* A√±ade esto dentro de <style> */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('https://onyxservices.github.io/cubanstore/fondo.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.15; /* 15% de opacidad */
      z-index: -1; /* Se coloca detr√°s de todo el contenido */
      pointer-events: none; /* No interfiere con los clics */
    }

    /* PANTALLA DE CARGA */
    #splash-screen {
  position: fixed;
  inset: 0;
  background: var(--primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.2s ease;
  /* Asegurar que est√© encima de todo */
}

/* Agrega esta clase para ocultar completamente */
.splash-hidden {
  opacity: 0 !important;
  visibility: hidden !important;
  pointer-events: none !important;
}

    .logo-premium {
      font-family: sans-serif;
      font-size: 3rem; font-weight: 800; color: var(--accent);
      text-transform: uppercase; letter-spacing: 4px;
      margin-bottom: 0.5rem;
      text-shadow: 0 0 20px rgba(212, 175, 55, 0.3);
    }

    /* Agregar esto en la secci√≥n de estilos */
    .delete-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      width: 36px;
      height: 36px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      flex-shrink: 0;
     }

    .delete-btn:hover {
      color: var(--error);
      border-color: var(--error);
     }
    
    .splash-subtitle {
      color: var(--text-muted); font-size: 0.9rem; letter-spacing: 5px;
      text-transform: uppercase; margin-bottom: 2rem;
      text-align: center;
    }

    .splash-footer {
      position: absolute; bottom: 40px;
      color: var(--text-muted); font-size: 0.7rem;
      letter-spacing: 3px; text-transform: uppercase;
      opacity: 0.6;
    }

    .loader-container { 
       width: 180px;
       height: 2px;
       background: rgba(255,255,255,0.05); 
       border-radius: 10px; overflow: hidden;
    }

    .loader-bar { 
       width: 40%; 
       height: 100%; 
       background: var(--accent); 
       animation: loading 3s infinite ease-in-out; }
    @keyframes loading { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }

    header {
      background: rgba(9, 9, 11, 0.95); padding: 0.8rem 1.2rem;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 1000; 
      border-bottom: 1px solid var(--border); backdrop-filter: blur(10px);
    }

    .brand { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; font-weight: 700; color: var(--accent); }
    .brand img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 1px solid var(--accent); }

     .spin {
        animation: spin 1s linear infinite;
     }  

    .header-actions { display: flex; align-items: center; gap: 10px; }

    /* SELECTOR DE PAGO STYLES */
    #payment-selector {
      background: var(--secondary);
      color: var(--accent);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.85rem;
      outline: none;
      cursor: pointer;
      appearance: none;
      text-align: center;
    }

    .cart-trigger {
      background: transparent; color: var(--text-main); border: 1px solid var(--border);
      width: 45px; height: 45px; border-radius: 10px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      position: relative; transition: var(--transition);
    }
    .cart-count {
      position: absolute; top: -5px; right: -8px;
      background: var(--accent); color: var(--primary);
      font-size: 10px; font-weight: 900; min-width: 18px; height: 18px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      border: 2px solid var(--primary);
    }

    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
    .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 20px; }
    @media (min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 24px; } }

    .card {
      background: var(--secondary); border-radius: var(--radius);
      overflow: hidden; border: 1px solid var(--border); transition: var(--transition);
      display: flex; flex-direction: column;
    }
    .card:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: var(--shadow); }
    .card-media { width: 100%; aspect-ratio: 1/1; overflow: hidden; background: #111; display: flex; align-items: center; justify-content: center; }
    .card-media img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
    .card-body { padding: 15px; display: flex; flex-direction: column; gap: 10px; flex-grow: 1; }
    .card-title { font-weight: 600; font-size: 0.85rem; color: var(--text-main); height: 2.5em; overflow: hidden; }
    .card-price { font-size: 1.1rem; font-weight: 800; color: var(--accent); }
    
    .btn-action {
      background: var(--accent); color: var(--primary); border: none; padding: 10px;
      border-radius: 8px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: var(--transition); font-size: 0.8rem;
    }

    /* Estilos para el Bocadillo de Sugerencia */
/* --- ESTILO DE NUBE PARA EL SUGERIDOR DE MONEDA --- */

/* --- ESTILO DE NUBE CORREGIDO --- */
.currency-hint {
  position: absolute;
  top: 60px; /* Ajustado para que pegue m√°s al selector */
  right: 70px; /* Ajustado para alinear con el select */
  background: var(--accent);
  color: var(--primary);
  padding: 10px 18px;
  border-radius: 30px; 
  font-size: 0.75rem;
  font-weight: 800;
  box-shadow: 0 10px 25px rgba(0,0,0,0.5);
  z-index: 2000; /* Asegurar que est√© por encima de todo */
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px) scale(0.8);
  transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 8px;
}

/* El "piquito" de la nube (ahora mejor posicionado) */
.currency-hint::before {
  content: "";
  position: absolute;
  top: -8px;
  right: 25px;
  width: 0;
  height: 0;
  border-left: 8px solid transparent;
  border-right: 8px solid transparent;
  border-bottom: 10px solid var(--accent);
}

/* C√≠rculos decorativos para efecto nube */
.currency-hint::after {
  content: "";
  position: absolute;
  background: var(--accent);
  width: 20px;
  height: 20px;
  border-radius: 50%;
  top: -10px;
  left: 20px;
  z-index: -1;
}

.currency-hint.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0) scale(1);
  animation: cloudFloat 3s ease-in-out infinite;
}

/* Ajuste para m√≥viles */
@media (max-width: 380px) {
  .currency-hint {
    right: 15px;
    font-size: 0.7rem;
  }
}

/* Ajuste para m√≥viles muy peque√±os */
@media (max-width: 380px) {
  .currency-hint {
    right: 20px;
    font-size: 0.7rem;
  }
  .currency-hint::after {
    right: 80px;
  }
}


    .btn-back-sticky {
      position: sticky; top: 73px; z-index: 990; background: transparent;
      border: none; color: var(--accent); cursor: pointer; display: flex;
      align-items: center; gap: 5px; padding: 15px 0; margin-top: -20px;
      margin-bottom: 10px; font-weight: 700; width: 100%;
    }

    .sentinel { grid-column: 1 / -1; height: 60px; display: flex; align-items: center; justify-content: center; }
    .scroll-loader { width: 25px; height: 25px; border: 3px solid rgba(212, 175, 55, 0.2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
    .sentinel.active .scroll-loader { display: block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .drawer-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      z-index: 2000; opacity: 0; visibility: hidden; transition: 0.3s; backdrop-filter: blur(8px);
    }
    .drawer-overlay.active { opacity: 1; visibility: visible; }
    
    .drawer {
      position: absolute; right: -100%; top: 0; width: 100%; max-width: 420px;
      height: 100%; background: var(--primary); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex; flex-direction: column; padding: 30px; border-left: 1px solid var(--border);
    }
    .drawer-overlay.active .drawer { right: 0; }

    .modal-center {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      background: var(--secondary); padding: 30px; border-radius: var(--radius);
      border: 1px solid var(--border); width: 90%; max-width: 360px; text-align: center;
    }
    .donation-img { width: 100%; border-radius: 10px; margin: 15px 0; border: 1px solid var(--border); }

    .cart-item { display: flex; align-items: center; gap: 15px; padding: 15px 0; border-bottom: 1px solid var(--border); }
    .qty-controls { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
    .qty-btn {
        background: var(--secondary); border: 1px solid var(--border); color: white;
        width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
    }

    .cart-form { margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
    .cart-form input {
      padding: 14px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--secondary); color: white; font-size: 0.9rem; outline: none;
    }
    .cart-form input.invalid { border-color: var(--error) !important; }

    .btn-whatsapp {
      background: #25D366; color: white; border: none; padding: 16px;
      border-radius: 10px; font-weight: 700; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 20px;
    }

    .footer-fixed {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      width: 95%; max-width: 400px; background: rgba(24, 24, 27, 0.85);
      backdrop-filter: blur(12px); border: 1px solid var(--border);
      border-radius: 20px; padding: 12px 15px; display: flex;
      justify-content: space-around; align-items: center; z-index: 1500;
    }

    .footer-link {
      color: var(--text-muted); text-decoration: none; display: flex;
      flex-direction: column; align-items: center; gap: 4px; transition: var(--transition);
      background: none; border: none; cursor: pointer; font-family: inherit;
    }
    .footer-link span { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

    .toast { 
       position: fixed; 
       bottom: 30px; 
       left: 50%; transform: translateX(-50%); background: var(--accent); color: var(--primary); padding: 12px 24px; border-radius: 8px; font-weight: 700; z-index: 3000; }
     
     /* Notificaci√≥n de Nuevo Producto */
.product-notification {
  position: fixed;
  top: 15px;
  right: -100%; /* Empieza fuera de la pantalla a la derecha */
  background: var(--accent);
  color: var(--primary);
  padding: 12px 20px;
  border-radius: 12px;
  font-weight: 700;
  z-index: 10000;
  display: flex;
  align-items: center;
  gap: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  transition: right 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  max-width: 85%;
}

.product-notification.active {
  right: 15px; /* Se desliza hacia adentro */
}

.product-notif-icon {
  background: var(--primary);
  color: var(--accent);
  width: 35px;
  height: 35px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
}
 
.toast-error { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--error); color: white; padding: 14px 28px; border-radius: 10px; font-weight: 700; z-index: 5000; display: flex; align-items: center; gap: 10px; animation: slideInDown 0.4s ease; }
    @keyframes slideInDown { from { transform: translate(-50%, -150%); } to { transform: translate(-50%, 0); } }

    .section-header { display: flex; align-items: center; gap: 12px; margin: 30px 0; }
    .section-header h2 { font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase; margin: 0; }

    .flying-cart-icon {
      position: fixed; z-index: 10000; pointer-events: none; color: var(--accent);
      transition: all 1.2s cubic-bezier(0.19, 1, 0.22, 1);
      display: flex; align-items: center; justify-content: center;
      background: var(--primary); border: 2px solid var(--accent);
      border-radius: 50%; width: 45px; height: 45px; opacity: 1;
    }

    /* Estilo para el cuadro de copiado de tarjeta */
    .card-copy-container {
      background: var(--primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .card-number-text {
      font-family: monospace;
      font-size: 1rem;
      color: var(--accent);
      letter-spacing: 1px;
    }
    .btn-copy-mini {
      background: var(--secondary);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 5px 8px;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
    }
    .btn-copy-mini:active {
      transform: scale(0.9);
      background: var(--accent);
      color: var(--primary);
    }

    /* Estilo para el contenedor de la tarjeta */
    .card-copy-box {
      background: var(--primary);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .card-number {
      font-family: 'Courier New', monospace;
      font-size: 1rem;
      color: var(--accent);
      font-weight: 700;
      letter-spacing: 1px;
    }
    .copy-btn {
      background: var(--accent);
      color: var(--primary);
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }
    .copy-btn:active {
      transform: scale(0.9);
    }

/* Ajuste para que los modales tengan scroll en m√≥viles */
#zelle-overlay .modal-center,
#mlc-overlay .modal-center,
#tra-overlay .modal-center {
  max-height: 85vh; /* Ocupa m√°ximo el 85% de la pantalla */
  overflow-y: auto; /* Habilita el scroll interno */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  -webkit-overflow-scrolling: touch; /* Suavidad en iOS */
  display: flex;
  flex-direction: column;
}

/* Asegurar que el contenido interno no se pegue a los bordes al hacer scroll */
#tra-overlay .modal-center {
  padding-bottom: 20px;
}
#remove-receipt {
  transition: all 0.2s ease;
}

#remove-receipt:hover {
  transform: scale(1.1);
}

.spin {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
  </style>
</head>
<body>

  <!-- PANTALLA DE CARGA -->
  <div id="splash-screen">
    <div class="logo-premium">Cuban Store</div>
    <div class="splash-subtitle">"üõíTodo lo que usted buscaüëú"</div>
    <div class="loader-container"><div class="loader-bar"></div></div>
    <div class="splash-footer">2026 Onyx-Services</div>
  </div>

  <header>
    <div class="brand">
      <img src="https://onyxservices.github.io/cubanstore/1.jpg" alt="Logo">
      <span>CUBAN STORE</span>
    </div>

    <div class="header-actions">
      <!-- SELECTOR DE PAGO DIN√ÅMICO -->
      <select id="payment-selector"></select>

      <button class="cart-trigger" id="cart-btn-anchor" onclick="toggleCart(true)">
        <i data-lucide="shopping-cart"></i>
        <div class="cart-count" id="cart-count">0</div>
      </button>
    </div>

    <div id="currency-hint" class="currency-hint">
    <div class="currency-hint-pointer"></div>
    <i data-lucide="info" style="width:14px; height:14px;"></i>
    Cambie aqu√≠ el tipo de moneda
</div>

  </header>

  <main class="container">
    <section id="categories-view">
      <div class="section-header">
        <i data-lucide="layout-grid" style="color: var(--accent)"></i>
        <h2>Categor√≠as</h2>
      </div>
      <div class="grid" id="categories-grid"></div>
    </section>

    <section id="products-view" style="display: none;">
      <button onclick="showCategories()" class="btn-back-sticky">
        <i data-lucide="chevron-left"></i> Volver a Categor√≠as
      </button>

      <div class="section-header">
        <i data-lucide="package" style="color: var(--accent)"></i>
        <h2 id="current-cat-name">Productos</h2>
      </div>
      <div class="grid" id="products-grid"></div>
      <div id="infinite-sentinel" class="sentinel">
        <div class="scroll-loader"></div>
      </div>
    </section>
  </main>

  <footer class="footer-fixed">
    <a href="tel:+5353910527" class="footer-link">
      <i data-lucide="phone"></i>
      <span>Soporte</span>
    </a>
    <div style="width: 1px; height: 20px; background: var(--border);"></div>
    <button class="footer-link" onclick="toggleCoffeeModal(true)">
      <i data-lucide="coffee"></i>
      <span>Caf√©</span>
    </button>
    <div style="width: 1px; height: 20px; background: var(--border);"></div>
    <a href="https://www.facebook.com/share/19h915VN2Q/?mibextid=wwXIfr" target="_blank" class="footer-link">
      <i data-lucide="facebook"></i>
      <span>Facebook</span>
    </a>
  </footer>
     
     <!-- MODAL COFFEE -->
  <div class="drawer-overlay" id="coffee-overlay" onclick="toggleCoffeeModal(false)">
    <div class="modal-center" onclick="event.stopPropagation()">
      <h3 style="margin:0; letter-spacing:1px; color: var(--accent);">Inv√≠tame un caf√© ‚òï</h3>
      <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 10px; line-height: 1.4;">Ayudas a mantener esta app para brindarte el mejor servicio.</p>
      
      <img src="https://onyxservices.github.io/cubanstore/donar-cafe.jpg" alt="Donaci√≥n" class="donation-img">

      <!-- BLOQUE DE TARJETA -->
      <div class="card-copy-box" style="background: var(--primary); border: 1px solid var(--border); border-radius: 10px; padding: 12px; margin: 15px 0; display: flex; align-items: center; justify-content: space-between;">
        <span id="card-number" style="font-family: monospace; color: var(--accent); font-weight: bold; font-size: 1rem;">9204-1299-7869-4034</span>
        <button onclick="window.copyToClipboard('9204-1299-7869-4034')" style="background: var(--accent); color: var(--primary); border: none; padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center;">
          <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
        </button>
      </div>

      <button class="btn-action" style="width: 100%;" onclick="toggleCoffeeModal(false)">ENTENDIDO</button>
    </div>
  </div>

<!-- Agregar despu√©s del modal coffee y antes del carrito -->

<!-- MODAL ZELLE -->
<div class="drawer-overlay" id="zelle-overlay" onclick="toggleZelleModal(false)">
  <div class="modal-center" onclick="event.stopPropagation()" style="max-width: 420px; text-align: left;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0; letter-spacing:1px; color: var(--accent);">Confirmar pago por Zelle</h3>
      <button onclick="toggleZelleModal(false)" style="background:none; border:none; color:white; cursor:pointer;">
        <i data-lucide="x"></i>
      </button>
    </div>
    
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; line-height: 1.4;">
      Por favor env√≠a el pago a la cuenta Zelle indicada y sube la captura de la transacci√≥n. Sin comprobante no se procesar√° el pedido.
    </p>
    
    <!-- Cuenta Zelle -->
    <div class="card-copy-box">
      <span class="card-number">Zelle: zelle@correo.com</span>
      <button class="copy-btn" onclick="copyToClipboard('zelle@correo.com')">
        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
      </button>
    </div>
    
    <!-- Resumen del pedido -->
    <div style="background: var(--primary); border-radius: 8px; padding: 12px; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="color: var(--text-muted);">Productos:</span>
        <span id="zelle-summary-items" style="font-weight: 600;">0</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span style="color: var(--text-muted);">Total:</span>
        <span id="zelle-summary-total" style="color: var(--accent); font-weight: 700;">$0</span>
      </div>
    </div>
    
    <!-- Input de imagen -->
    <div style="margin: 20px 0;">
      <input type="file" id="receipt-file" accept="image/png, image/jpeg, .png, .jpg, .jpeg" 
             style="display: none;" onchange="handleReceiptFileInput(event)">
      
      <button id="select-receipt-btn" class="btn-action" style="width: 100%;" onclick="document.getElementById('receipt-file').click()">
        <i data-lucide="upload"></i> SELECCIONAR IMAGEN
      </button>
      
      <div id="receipt-preview-container" style="display: none; margin-top: 15px;">
        <div style="position: relative;">
          <img id="receipt-preview" style="width: 100%; border-radius: 8px; border: 1px solid var(--border);">
          <button id="remove-receipt" 
        style="position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;"
        onclick="removeReceiptPreview()">
  <i data-lucide="x" style="width: 16px;"></i>
</button>
        </div>
        <p id="file-info" style="color: var(--text-muted); font-size: 0.8rem; margin-top: 5px; text-align: center;"></p>
      </div>
      
      <div id="upload-progress" style="display: none; text-align: center; margin: 15px 0;">
        <div class="scroll-loader" style="margin: 0 auto;"></div>
        <p style="color: var(--accent); font-size: 0.85rem; margin-top: 8px;">Subiendo comprobante...</p>
      </div>
      
      <p id="file-error" style="color: var(--error); font-size: 0.8rem; margin-top: 5px; display: none;"></p>
    </div>
    
    <!-- Botones -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn-action" style="flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-main);" 
              onclick="toggleZelleModal(false)" id="cancel-zelle-btn">
        CANCELAR
      </button>
      <button class="btn-action" style="flex: 1;" id="confirm-zelle-btn" disabled onclick="confirmZellePayment()">
        <i data-lucide="check-circle"></i> CONFIRMAR PAGO
      </button>
    </div>
  </div>
</div>

<!-- MODAL TRANSFERENCIA -->
<div class="drawer-overlay" id="tra-overlay" onclick="toggleTraModal(false)">
  <div class="modal-center" onclick="event.stopPropagation()" style="max-width: 420px; text-align: left;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0; letter-spacing:1px; color: var(--accent);">Confirmar Transferencia</h3>
      <button onclick="toggleTraModal(false)" style="background:none; border:none; color:white; cursor:pointer;">
        <i data-lucide="x"></i>
      </button>
    </div>
    
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px; line-height: 1.4;">
      Por favor transfiera al siguiente n√∫mero de tarjeta y suba la captura del SMS de la transacci√≥n.
    </p>
    
    <!-- Cuenta de Transferencia (Misma del Caf√©) -->
    <div class="card-copy-box">
      <span class="card-number">9204-1299-7869-4034</span>
      <button class="copy-btn" onclick="copyToClipboard('9204-1299-7869-4034')">
        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
      </button>
    </div>
    
    <!-- Resumen -->
    <div style="background: var(--primary); border-radius: 8px; padding: 12px; margin: 15px 0;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
        <span style="color: var(--text-muted);">Productos:</span>
        <span id="tra-summary-items" style="font-weight: 600;">0</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span style="color: var(--text-muted);">Total:</span>
        <span id="tra-summary-total" style="color: var(--accent); font-weight: 700;">$0</span>
      </div>
    </div>
    
    <!-- Input de imagen -->
    <div style="margin: 20px 0;">
      <input type="file" id="tra-receipt-file" accept="image/png, image/jpeg, .png, .jpg, .jpeg" 
             style="display: none;" onchange="handleTraReceiptFileInput(event)">
      
      <button id="tra-select-btn" class="btn-action" style="width: 100%;" onclick="document.getElementById('tra-receipt-file').click()">
        <i data-lucide="upload"></i> SELECCIONAR COMPROBANTE
      </button>
      
      <div id="tra-preview-container" style="display: none; margin-top: 15px;">
        <div style="position: relative;">
          <img id="tra-preview" style="width: 100%; border-radius: 8px; border: 1px solid var(--border);">
          <button style="position: absolute; top: 10px; right: 10px; background: var(--error); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;"
                  onclick="removeTraReceiptPreview()">
            <i data-lucide="x" style="width: 16px;"></i>
          </button>
        </div>
      </div>
      
      <div id="tra-upload-progress" style="display: none; text-align: center; margin: 15px 0;">
        <div class="scroll-loader" style="margin: 0 auto;"></div>
        <p style="color: var(--accent); font-size: 0.85rem; margin-top: 8px;">Subiendo comprobante...</p>
      </div>
      <p id="tra-file-error" style="color: var(--error); font-size: 0.8rem; margin-top: 5px; display: none;"></p>
    </div>
    
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn-action" style="flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-main);" 
              onclick="toggleTraModal(false)">CANCELAR</button>
      <button class="btn-action" style="flex: 1;" id="confirm-tra-btn" disabled onclick="confirmTraPayment()">
        <i data-lucide="check-circle"></i> ENVIAR PAGO
      </button>
    </div>
  </div>
</div>

<!-- MODAL MLC -->
<div class="drawer-overlay" id="mlc-overlay" onclick="toggleMlcModal(false)">
  <div class="modal-center" onclick="event.stopPropagation()">
    
    <!-- Encabezado -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0; letter-spacing:1px; color: var(--accent); font-size: 1.1rem;">Confirmar Pago MLC</h3>
      <button onclick="toggleMlcModal(false)" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">
        <i data-lucide="x"></i>
      </button>
    </div>
    
    <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px; line-height: 1.4;">
      Por favor transfiera a la tarjeta <b>MLC</b> y suba la captura de pantalla del comprobante.
    </p>
    
    <!-- Tarjeta Copiable -->
    <div class="card-copy-box">
      <span class="card-number" id="mlc-card-val">9225 0000 0000 0000</span>
      <button class="copy-btn" onclick="copyToClipboard('9225 0000 0000 0000')">
        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
      </button>
    </div>
    
    <!-- Resumen Din√°mico -->
    <div style="background: var(--primary); border-radius: 10px; padding: 15px; margin: 15px 0; border: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem;">
        <span style="color: var(--text-muted);">Productos:</span>
        <span id="mlc-summary-items" style="font-weight: 600;">0</span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span style="color: var(--text-muted); font-size: 0.85rem;">Total MLC:</span>
        <span id="mlc-summary-total" style="color: var(--accent); font-weight: 800; font-size: 1.2rem;">0.00</span>
      </div>
    </div>
    
    <!-- Area de Carga de Imagen -->
    <div style="margin: 10px 0;">
      <input type="file" id="mlc-receipt-file" accept="image/*" style="display: none;" onchange="handleMlcReceiptFileInput(event)">
      
      <button id="mlc-select-btn" class="btn-action" style="width: 100%; height: 50px;" onclick="document.getElementById('mlc-receipt-file').click()">
        <i data-lucide="camera"></i> SUBIR COMPROBANTE
      </button>
      
      <!-- Vista previa con bot√≥n de borrar -->
      <div id="mlc-preview-container" style="display: none; margin-top: 15px; position: relative;">
        <img id="mlc-preview" style="width: 100%; border-radius: 10px; border: 1px solid var(--accent); display: block;">
        <button id="remove-mlc-receipt" 
                onclick="removeMlcReceiptPreview()"
                style="position: absolute; top: -10px; right: -10px; background: var(--error); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
          <i data-lucide="trash-2" style="width: 16px;"></i>
        </button>
      </div>
      
      <!-- Loader de subida -->
      <div id="mlc-upload-progress" style="display: none; text-align: center; margin: 15px 0;">
        <div class="scroll-loader" style="margin: 0 auto;"></div>
        <p style="color: var(--accent); font-size: 0.8rem; margin-top: 8px; font-weight: 600;">Procesando env√≠o...</p>
      </div>
    </div>
    
    <!-- Botones de Acci√≥n -->
    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button class="btn-action" style="flex: 1; background: #27272a; color: white;" onclick="toggleMlcModal(false)">CANCELAR</button>
      <button class="btn-action" style="flex: 1.5;" id="confirm-mlc-btn" disabled onclick="confirmMlcPayment()">
        <i data-lucide="send"></i> ENVIAR PAGO
      </button>
    </div>

  </div>
</div>

  <!-- CARRITO -->
  <div class="drawer-overlay" id="cart-overlay" onclick="toggleCart(false)">
    <div class="drawer" onclick="event.stopPropagation()">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
        <h3 style="margin:0; letter-spacing:1px;">Mi Pedido</h3>
        <button onclick="toggleCart(false)" style="background:none; border:none; color:white;"><i data-lucide="x"></i></button>
      </div>
      <div id="cart-list" style="flex:1; overflow-y:auto;"></div>
      <div style="border-top: 1px solid var(--border); padding-top:20px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
          <span style="color:var(--text-muted)">TOTAL</span>
          <span id="cart-total" style="color:var(--accent); font-size:1.5rem; font-weight:800;">$0</span>
        </div>
        <div class="cart-form" id="order-form">
  <input type="text" id="order-name" placeholder="Nombre completo">
  <input type="text" id="order-address" placeholder="Direcci√≥n exacta">
  <!-- Nuevo campo agregado -->
  <input type="text" id="order-reference" placeholder="Referencia (Ej: Casa de rejas verdes, apto...)">
  <input type="tel" id="order-phone" placeholder="Tel√©fono (Ej: 5 o 6 /1234567)" maxlength="8">
</div>
        <button class="btn-whatsapp" onclick="sendOrder()">
          <i data-lucide="send"></i> ENVIAR PEDIDO POR WHATSAPP
        </button>
      </div>
    </div>
  </div>

  <div id="toast-root"></div>

  <script type="module">
import { 
  getCategories, 
  getAllProducts, 
  getPaymentMethods, 
  createOrderInSupabase, // <--- Agregar esta
  uploadReceiptToSupabase // <--- Agregar esta
} from './api.js';

// --- ESTADO GLOBAL ---
let DB = { categories: [], products: [], paymentMethods: [] };
let knownProductIds = new Set(); 
let cart = [];
let currentPaymentMethodCode = "$"; 
let currentView = { type: 'categories', catId: null, catName: null };
let filteredProducts = [];
let itemsPerPage = 8;
let currentPage = 1;
let observer = null;
let zelleReceiptFile = null;
let zelleReceiptUrl = null;
let traReceiptFile = null;
let mlcReceiptFile = null;
let currentZelleOrderData = null;

// --- AUDIO ---
const soundAddCart = new Audio('https://onyxservices.github.io/cubanstore/agregado.mp3');
const soundNewProduct = new Audio('https://onyxservices.github.io/cubanstore/new.mp3');

function setupPaymentListener() {
  const sel = document.getElementById('payment-selector');
  if (!sel) return;

  sel.addEventListener('change', (e) => {
    // 1. Actualizamos el c√≥digo de moneda global (ej: "CUP", "MLC", "USD")
    currentPaymentMethodCode = e.target.value;
    
    // 2. Refrescamos los productos que est√°n en pantalla para que cambien de precio
    if (currentView.type === 'products') {
      softRefreshProducts();
    }
    
    // 3. Refrescamos el carrito para que el total se recalcule
    updateCartUI();
    
    console.log("Moneda cambiada a:", currentPaymentMethodCode);
  });
}

/**
 * INICIALIZACI√ìN
 */
async function init() {
  loadCartFromStorage();
  setTimeout(showCurrencyHint, 2500);

  const splash = document.getElementById('splash-screen');

  // --- SOLUCI√ìN: Temporizador de seguridad ---
  // Si en 6 segundos no ha cargado la base de datos, quita el splash de todos modos
  const forceHide = setTimeout(() => {
    console.warn("La base de datos tarda demasiado. Iniciando app con datos locales...");
    ocultarSplash(splash);
  }, 6000);

  try {
    // Intentamos cargar los datos
    await refreshData(true);
  } catch (error) {
    // Si la tabla no existe o hay error de red, lo capturamos aqu√≠
    console.error("Error cr√≠tico cargando datos de Supabase:", error);
  } finally {
    // Pase lo que pase (√©xito o error), quitamos el temporizador y ocultamos splash
    clearTimeout(forceHide);
    
    const hasSeenSplash = sessionStorage.getItem('cuban_store_splash_seen');
    if (!hasSeenSplash) {
      setTimeout(() => {
        ocultarSplash(splash);
        sessionStorage.setItem('cuban_store_splash_seen', 'true');
      }, 2000);
    } else {
      ocultarSplash(splash);
    }
  }

  setupPaymentListener();
  updateCartUI();
  setupFormValidation();
  setupInfiniteScroll();
  lucide.createIcons();
  startBackgroundSync();
}

/**
 * NOTIFICACI√ìN DE PRODUCTO NUEVO (Derecha a Izquierda)
 */
function notifyNewProduct(categoryName) {
  // Reproducir sonido
  soundNewProduct.currentTime = 0;
  soundNewProduct.play().catch(e => console.log("Audio esperando interacci√≥n"));

  const notif = document.createElement('div');
  notif.className = 'product-notification';
  notif.innerHTML = `
    <div class="product-notif-icon"><i data-lucide="sparkles"></i></div>
    <div>
      <div style="font-size: 0.7rem; opacity: 0.8; text-transform: uppercase;">¬°Reci√©n llegado!</div>
      <div style="font-size: 0.9rem;">Nuevo producto en ${categoryName}</div>
    </div>
  `;
  document.body.appendChild(notif);
  lucide.createIcons();

  // Animaci√≥n entrada
  setTimeout(() => notif.classList.add('active'), 100);

  // Animaci√≥n salida y borrado
  setTimeout(() => {
    notif.classList.remove('active');
    setTimeout(() => notif.remove(), 600);
  }, 8000);
}

/**
 * CARGA Y ACTUALIZACI√ìN DE DATOS CON DETECCI√ìN DE NOVEDADES
 */
async function refreshData(isFirstLoad = false) {
  try {
    const [newCats, newProds, newPays] = await Promise.all([
      getCategories(),
      getAllProducts(),
      getPaymentMethods()
    ]);

    const categories = newCats || [];
    const products = newProds || [];

    // L√≥gica de detecci√≥n: Solo si no es la primera carga y hay productos nuevos
    if (!isFirstLoad && products.length > 0) {
      products.forEach(prod => {
        if (!knownProductIds.has(String(prod.id))) {
          const cat = categories.find(c => String(c.id) === String(prod.category_id));
          const catName = cat ? cat.name : "una categor√≠a";
          notifyNewProduct(catName);
        }
      });
    }

    // Actualizar conjunto de IDs conocidos
    knownProductIds = new Set(products.map(p => String(p.id)));

    // Actualizar DB global
    DB.categories = categories;
    DB.products = products;
    DB.paymentMethods = newPays || [];

    if (DB.paymentMethods.length > 0) renderPaymentSelector();

    // Refrescar vistas
    if (currentView.type === 'categories') {
      renderCategories();
    } else if (currentView.type === 'products') {
      filteredProducts = DB.products.filter(p => String(p.category_id) === String(currentView.catId));
      softRefreshProducts();
    }
  } catch (err) {
    console.error("Error al refrescar datos:", err);
  }
}

function startBackgroundSync() {
  setTimeout(async function sync() {
    await refreshData(false);
    setTimeout(sync, 40000); 
  }, 40000);
}

function startCurrencySync() {
  setInterval(async () => {
    try {
      const newPays = await getPaymentMethods();
      // Solo actualizamos el DOM si los datos han cambiado para evitar parpadeos
      if (newPays && JSON.stringify(newPays) !== JSON.stringify(DB.paymentMethods)) {
        DB.paymentMethods = newPays;
        renderPaymentSelector();
        
        // Refrescar precios en la vista actual si es necesario
        if (currentView.type === 'products') {
          softRefreshProducts();
        }
        updateCartUI();
      }
    } catch (err) {
      console.error("Error al actualizar monedas en segundo plano:", err);
    }
  }, 5000); // 5000ms = 5 segundos
}

/**
 * UI / RENDERIZADO
 */
function ocultarSplash(el) {
  if (!el) return;
  el.style.opacity = '0';
  setTimeout(() => {
    el.style.display = 'none';
    el.classList.add('splash-hidden');
  }, 300);
}

function getFinalPrice(basePrice) {
  const method = DB.paymentMethods.find(m => m.code === currentPaymentMethodCode) || 
                 { name: "Efectivo", mode: "none", value: 1, code: "$" };
  
  let final = parseFloat(basePrice);
  // Si el c√≥digo es $, usamos el s√≠mbolo, si es otra cosa (MLC, CUP), usamos el texto
  let prefix = method.code === "$" ? "$" : method.code + " ";

  if (method.mode === 'percent') {
    final = basePrice * (1 + (method.value / 100));
  } else if (method.mode === 'divide') {
    final = basePrice / method.value;
  }

  return { 
    text: `${prefix}${final.toLocaleString(undefined, { 
      minimumFractionDigits: 2, 
      maximumFractionDigits: 2 
    })}`, 
    methodName: method.name 
  };
}
function renderPaymentSelector() {
  const sel = document.getElementById('payment-selector');
  if (!sel) return;

  // FILTRO: Solo tomamos los m√©todos donde active sea true
  const activeMethods = DB.paymentMethods.filter(m => m.active === true);

  sel.innerHTML = activeMethods.map(m =>
    `<option value="${m.code}" ${m.code === currentPaymentMethodCode ? 'selected' : ''}>${m.name}</option>`
  ).join('');
  
  // Opcional: Si el m√©todo seleccionado actualmente se desactiv√≥, 
  // podr√≠as querer resetearlo al primero disponible ($)
  if (activeMethods.length > 0 && !activeMethods.find(m => m.code === currentPaymentMethodCode)) {
      currentPaymentMethodCode = activeMethods[0].code;
  }
}
function showCurrencyHint() {
  // Verificar si ya se mostr√≥ en esta sesi√≥n
  if (sessionStorage.getItem("currency_hint_seen")) return;

  const hint = document.getElementById("currency-hint");
  if (!hint) return;

  // Aparecer despu√©s de 1.5 segundos de carga para que el usuario lo note
  setTimeout(() => {
    hint.classList.add("show");
  }, 1500);

  // Desaparecer despu√©s de 5 segundos de estar visible
  setTimeout(() => {
    hint.classList.remove("show");
    // Guardar en sesi√≥n para que no vuelva a salir hasta que cierre el navegador
    sessionStorage.setItem("currency_hint_seen", "true");
  }, 6500); // 1.5s delay + 5s visible
}


window.showCategories = () => {
  currentView = { type: 'categories', catId: null, catName: null };
  document.getElementById('products-view').style.display = 'none';
  document.getElementById('categories-view').style.display = 'block';
  renderCategories();
};

window.showProducts = (catId, catName) => {
  currentView = { type: 'products', catId: catId, catName: catName };
  document.getElementById('categories-view').style.display = 'none';
  document.getElementById('products-view').style.display = 'block';
  document.getElementById('current-cat-name').innerText = catName;

  const grid = document.getElementById('products-grid');
  grid.innerHTML = '';
  currentPage = 1;
  filteredProducts = DB.products.filter(p => 
    String(p.category_id) === String(catId) && p.active === true
  );
  renderNextChunk();
  window.scrollTo(0, 0);
};

function renderCategories() {
  const grid = document.getElementById('categories-grid');
  if (!grid) return;
  grid.innerHTML = DB.categories.map(cat => `
    <div class="card" onclick="showProducts('${cat.id}', '${cat.name}')" style="cursor:pointer">
      <div class="card-media"><img src="${cat.image_url || 'https://via.placeholder.com/300'}" onerror="this.src='https://via.placeholder.com/300'"></div>
      <div class="card-body" style="text-align:center;">
        <div class="card-title" style="height:auto; font-size:0.9rem; font-weight:700;">${cat.name}</div>
      </div>
    </div>
  `).join('');
  lucide.createIcons();
}

function renderNextChunk() {
  const grid = document.getElementById('products-grid');
  const sentinel = document.getElementById('infinite-sentinel');
  const start = (currentPage - 1) * itemsPerPage;
  const end = start + itemsPerPage;
  const chunk = filteredProducts.slice(start, end);

  if (chunk.length === 0) {
    sentinel.classList.remove('active');
    return;
  }

  sentinel.classList.add('active');
  const html = chunk.map(p => productCardHTML(p)).join('');
  grid.insertAdjacentHTML('beforeend', html);
  lucide.createIcons();
  currentPage++;

  if (end >= filteredProducts.length) sentinel.classList.remove('active');
}

function softRefreshProducts() {
  const grid = document.getElementById('products-grid');
  if (!grid || currentView.type !== 'products') return;
  const limit = (currentPage - 1) * itemsPerPage;
  const visibleSet = filteredProducts.slice(0, Math.max(limit, itemsPerPage));
  grid.innerHTML = visibleSet.map(p => productCardHTML(p)).join('');
  lucide.createIcons();
}

function productCardHTML(p) {
  const priceObj = getFinalPrice(p.price);
  return `
    <div class="card">
      <div class="card-media">
        <img src="${p.image_url || 'https://via.placeholder.com/300'}" loading="lazy" onerror="this.src='https://via.placeholder.com/300'">
      </div>
      <div class="card-body">
        <div class="card-title">${p.name}</div>
        <div class="card-price">${priceObj.text}</div>
        <button class="btn-action" onclick="addToCart('${p.id}', event)">
          <i data-lucide="shopping-cart" style="width:14px"></i> AGREGAR
        </button>
      </div>
    </div>
  `;
}

/**
 * CARRITO
 */
window.addToCart = (id, event) => {
  const product = DB.products.find(p => String(p.id) === String(id));
  if (!product) return;

  soundAddCart.currentTime = 0;
  soundAddCart.play().catch(()=>{});

  if (event) {
    const btn = event.currentTarget;
    const cartBtn = document.getElementById('cart-btn-anchor');
    const rect = btn.getBoundingClientRect();
    const cartRect = cartBtn.getBoundingClientRect();
    const flyer = document.createElement('div');
    flyer.className = 'flying-cart-icon';
    flyer.innerHTML = '<i data-lucide="shopping-cart"></i>';
    flyer.style.left = `${rect.left + rect.width / 2 - 22}px`;
    flyer.style.top = `${rect.top + rect.height / 2 - 22}px`;
    document.body.appendChild(flyer);
    lucide.createIcons({ attrs: { style: "width: 18px;" } });
    
    requestAnimationFrame(() => {
      setTimeout(() => {
        flyer.style.left = `${cartRect.left + cartRect.width / 2 - 22}px`;
        flyer.style.top = `${cartRect.top + cartRect.height / 2 - 22}px`;
        flyer.style.transform = 'scale(0.3) rotate(360deg)';
        flyer.style.opacity = '0';
      }, 50);
    });
    setTimeout(() => flyer.remove(), 1000);
  }

  const existing = cart.find(item => String(item.id) === String(id));
  if (existing) {
    existing.qty += 1;
  } else {
    cart.push({ ...product, qty: 1 });
  }

  saveCartToStorage();
  updateCartUI();
  showToast("Producto a√±adido");
};

window.updateQty = (index, delta) => {
  if (!cart[index]) return;
  cart[index].qty += delta;
  if (cart[index].qty <= 0) cart.splice(index, 1);
  saveCartToStorage();
  updateCartUI();
};

window.removeFromCart = (index) => {
  cart.splice(index, 1);
  saveCartToStorage();
  updateCartUI();
};

function updateCartUI() {
  const list = document.getElementById('cart-list');
  const totalEl = document.getElementById('cart-total');
  let totalBase = 0, totalItems = 0;

  if (cart.length === 0) {
    list.innerHTML = `<p style="text-align:center; color:var(--text-muted); margin-top:40px;">Tu carrito est√° vac√≠o</p>`;
    totalEl.innerText = "$0";
    document.getElementById('cart-count').innerText = "0";
    return;
  }

  list.innerHTML = cart.map((item, i) => {
    totalBase += (parseFloat(item.price) * item.qty);
    totalItems += item.qty;
    const pObj = getFinalPrice(item.price);
    return `
      <div class="cart-item">
        <img src="${item.image_url}" style="width:50px; height:50px; border-radius:6px; object-fit:cover" onerror="this.src='https://via.placeholder.com/300'">
        <div class="cart-item-info" style="flex:1">
          <h4 style="margin:0; font-size:0.85rem">${item.name}</h4>
          <span style="color:var(--accent); font-weight:700">${pObj.text}</span>
          <div class="qty-controls">
            <button class="qty-btn" onclick="updateQty(${i}, -1)"><i data-lucide="minus" style="width:14px"></i></button>
            <span>${item.qty}</span>
            <button class="qty-btn" onclick="updateQty(${i}, 1)"><i data-lucide="plus" style="width:14px"></i></button>
          </div>
        </div>
        <button class="delete-btn" onclick="removeFromCart(${i})">
          <i data-lucide="trash-2" style="width:16px"></i>
        </button>
      </div>
    `;
  }).join('');

  const finalTotal = getFinalPrice(totalBase);
  totalEl.innerText = finalTotal.text;
  document.getElementById('cart-count').innerText = totalItems;
  lucide.createIcons();
}

/**
 * ENV√çO PEDIDO
 */
// En la funci√≥n sendOrder original, aseg√∫rate de cerrar el carrito cuando se procese Zelle
window.sendOrder = () => {
  const nameInput = document.getElementById('order-name');
  const addrInput = document.getElementById('order-address');
  const refInput = document.getElementById('order-reference');
  const phoneInput = document.getElementById('order-phone');

  const name = nameInput.value.trim();
  const addr = addrInput.value.trim();
  const ref = refInput.value.trim();
  const phone = phoneInput.value.trim();

  if (cart.length === 0) { 
    showTopError("El carrito est√° vac√≠o"); 
    return; 
  }
  
  let hasError = false;
  if (name.length < 3) { nameInput.classList.add('invalid'); hasError = true; }
  if (addr.length < 5) { addrInput.classList.add('invalid'); hasError = true; }
  if (!/^[56]\d{7}$/.test(phone)) { phoneInput.classList.add('invalid'); hasError = true; }

  if (hasError) { showTopError("Revisa los datos marcados"); return; }

  // Si el m√©todo de pago es Zelle, abrir modal y CERRAR CARRITO
  if (currentPaymentMethodCode === 'Z') {
    // Primero cerrar carrito
    toggleCart(false);
    // Luego abrir modal Zelle
    openZelleModal();
    return;
  }

  let totalBase = 0;
  const itemsList = cart.map(item => {
    totalBase += (parseFloat(item.price) * item.qty);
    const pObj = getFinalPrice(item.price);
    return `‚Ä¢ *${item.qty}x* ${item.name} _(${pObj.text})_`;
  }).join('\n');

  const finalTotalObj = getFinalPrice(totalBase);
  const text = encodeURIComponent(
    `üëë *NUEVO PEDIDO | CUBAN STORE*\n\n` +
    `üë§ *Cliente:* ${name}\n` +
    `üìç *Direcci√≥n:* ${addr}\n` +
    (ref ? `üè† *Referencia:* ${ref}\n` : '') +
    `üìû *Tel√©fono:* +53${phone}\n` +
    `üí≥ *M√©todo de Pago:* ${finalTotalObj.methodName}\n\n` +
    `üõçÔ∏è *PRODUCTOS:*\n${itemsList}\n\n` +
    `üí∞ *TOTAL A PAGAR:* ${finalTotalObj.text}\n\n` +
    `‚úÖ _Espere su confirmaci√≥n, gracias..._`
  );

  window.open(`https://wa.me/+5353910527?text=${text}`, '_blank');
  
  cart = [];
  document.querySelectorAll('#order-form input').forEach(i => { i.value = ''; i.classList.remove('invalid'); });
  saveCartToStorage();
  updateCartUI();
  toggleCart(false);
  showToast("¬°Pedido enviado!");
};

/**
 * UTILIDADES
 */
function setupInfiniteScroll() {
  const sentinel = document.getElementById('infinite-sentinel');
  if (!sentinel) return;
  observer = new IntersectionObserver((entries) => {
    if (entries[0].isIntersecting && filteredProducts.length > 0 && currentView.type === 'products') {
      renderNextChunk();
    }
  }, { rootMargin: '200px' });
  observer.observe(sentinel);
}

function setupFormValidation() {
  document.querySelectorAll('.cart-form input').forEach(input => {
    input.addEventListener('input', () => input.classList.remove('invalid'));
  });
}

window.toggleCart = (open) => document.getElementById('cart-overlay').classList.toggle('active', open);
window.toggleCoffeeModal = (open) => {
  document.getElementById('coffee-overlay').classList.toggle('active', open);
  if(open) setTimeout(() => lucide.createIcons(), 100);
};

function saveCartToStorage() { localStorage.setItem('cuban_store_cart', JSON.stringify(cart)); }
function loadCartFromStorage() { 
  const s = localStorage.getItem('cuban_store_cart'); 
  if (s) { try { cart = JSON.parse(s); } catch (e) { cart = []; } } 
}

function showTopError(m) {
  const r = document.getElementById('toast-root');
  const t = document.createElement('div');
  t.className = 'toast-error';
  t.innerHTML = `<i data-lucide="alert-circle"></i> <span>${m}</span>`;
  r.appendChild(t);
  lucide.createIcons();
  setTimeout(() => t.remove(), 3000);
}

function showToast(m) {
  const r = document.getElementById('toast-root');
  const t = document.createElement('div');
  t.className = 'toast';
  t.innerText = m;
  r.appendChild(t);
  setTimeout(() => t.remove(), 2000);
}

window.onBackPressed = function() {
  if (document.getElementById('cart-overlay').classList.contains('active')) { toggleCart(false); return; }
  if (document.getElementById('coffee-overlay').classList.contains('active')) { toggleCoffeeModal(false); return; }
  if (currentView.type === 'products') { showCategories(); return; }
  if (window.AppInventor) window.AppInventor.setWebViewString("salir");
};

window.copyToClipboard = function(text) {
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(() => showToast("‚úÖ ¬°Copiado!")).catch(() => fallbackCopy(text));
  } else { fallbackCopy(text); }
};

function fallbackCopy(text) {
  const ta = document.createElement("textarea"); ta.value = text;
  document.body.appendChild(ta); ta.select();
  try { document.execCommand('copy'); showToast("‚úÖ ¬°Copiado!"); } catch (e) { showTopError("Error al copiar"); }
  document.body.removeChild(ta);
}

/**
 * MODAL Y FLUJO ZELLE
 */
/**
 * MODAL Y FLUJO ZELLE - VERSI√ìN CORREGIDA
 */
window.openZelleModal = () => {
  // 1. CERRAR EL CARRITO SI EST√Å ABIERTO
  toggleCart(false);
  
  // 2. Calcular resumen
  let totalBase = 0;
  let totalItems = 0;
  
  cart.forEach(item => {
    totalBase += (parseFloat(item.price) * item.qty);
    totalItems += item.qty;
  });
  
  const finalTotal = getFinalPrice(totalBase);
  
  // 3. Actualizar resumen en modal
  document.getElementById('zelle-summary-items').textContent = totalItems;
  document.getElementById('zelle-summary-total').textContent = finalTotal.text;
  
  // 4. Resetear estado COMPLETO (eliminar vista previa)
  resetZelleModalState();
  
  // 5. Mostrar modal
  toggleZelleModal(true);
  lucide.createIcons();
};

// Funci√≥n para resetear completamente el estado del modal Zelle
function resetZelleModalState() {
  zelleReceiptFile = null;
  zelleReceiptUrl = null;
  
  // Limpiar vista previa si existe
  const preview = document.getElementById('receipt-preview');
  if (preview && preview.src && preview.src.startsWith('blob:')) {
    URL.revokeObjectURL(preview.src);
    preview.src = '';
  }
  
  // Resetear UI
  document.getElementById('receipt-preview-container').style.display = 'none';
  document.getElementById('upload-progress').style.display = 'none';
  document.getElementById('file-error').style.display = 'none';
  document.getElementById('file-error').textContent = '';
  document.getElementById('confirm-zelle-btn').disabled = true;
  document.getElementById('select-receipt-btn').innerHTML = '<i data-lucide="upload"></i> SELECCIONAR IMAGEN';
  document.getElementById('select-receipt-btn').disabled = false;
  document.getElementById('receipt-file').value = '';
  document.getElementById('file-info').textContent = '';
}

window.toggleZelleModal = (open) => {
  const overlay = document.getElementById('zelle-overlay');
  overlay.classList.toggle('active', open);
  
  // Si se est√° cerrando, limpiar completamente
  if (!open) {
    resetZelleModalState();
  } else {
    setTimeout(() => lucide.createIcons(), 100);
  }
};

window.handleReceiptFileInput = (event) => {
  const file = event.target.files[0];
  if (!file) return;
  
  // Limpiar estado previo si existe
  if (zelleReceiptFile && document.getElementById('receipt-preview').src) {
    URL.revokeObjectURL(document.getElementById('receipt-preview').src);
  }
  
  // Validaciones
  const validTypes = ['image/png', 'image/jpeg'];
  const maxSize = 5 * 1024 * 1024; // 5MB
  
  if (!validTypes.includes(file.type)) {
    showFileError('Solo se permiten im√°genes PNG o JPEG');
    document.getElementById('receipt-file').value = '';
    return;
  }
  
  if (file.size > maxSize) {
    showFileError('La imagen no debe superar 5 MB');
    document.getElementById('receipt-file').value = '';
    return;
  }
  
  // Mostrar vista previa
  zelleReceiptFile = file;
  const previewUrl = URL.createObjectURL(file);
  const preview = document.getElementById('receipt-preview');
  const container = document.getElementById('receipt-preview-container');
  const fileInfo = document.getElementById('file-info');
  
  preview.src = previewUrl;
  container.style.display = 'block';
  fileInfo.textContent = `${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
  
  // Configurar bot√≥n eliminar (nueva funci√≥n mejorada)
  const removeBtn = document.getElementById('remove-receipt');
  removeBtn.onclick = () => {
    if (preview.src && preview.src.startsWith('blob:')) {
      URL.revokeObjectURL(preview.src);
    }
    zelleReceiptFile = null;
    preview.src = '';
    container.style.display = 'none';
    document.getElementById('receipt-file').value = '';
    document.getElementById('confirm-zelle-btn').disabled = true;
    document.getElementById('file-error').style.display = 'none';
    document.getElementById('file-error').textContent = '';
    lucide.createIcons();
  };
  
  // Habilitar confirmaci√≥n
  document.getElementById('confirm-zelle-btn').disabled = false;
  document.getElementById('file-error').style.display = 'none';
  
  lucide.createIcons();
};

window.removeReceiptPreview = function() {
  // Liberar URL del blob si existe
  const preview = document.getElementById('receipt-preview');
  if (preview && preview.src && preview.src.startsWith('blob:')) {
    URL.revokeObjectURL(preview.src);
    preview.src = '';
  }
  
  // Resetear variables
  zelleReceiptFile = null;
  zelleReceiptUrl = null;
  
  // Ocultar vista previa
  document.getElementById('receipt-preview-container').style.display = 'none';
  
  // Limpiar input file
  document.getElementById('receipt-file').value = '';
  
  // Deshabilitar bot√≥n confirmar
  document.getElementById('confirm-zelle-btn').disabled = true;
  
  // Ocultar errores
  document.getElementById('file-error').style.display = 'none';
  document.getElementById('file-error').textContent = '';
  
  // Actualizar iconos
  lucide.createIcons();
};

function showFileError(message) {
  const errorEl = document.getElementById('file-error');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  document.getElementById('confirm-zelle-btn').disabled = true;
}

window.openMlcModal = () => {
  toggleCart(false);
  let totalBase = 0, totalItems = 0;
  cart.forEach(item => { totalBase += (parseFloat(item.price) * item.qty); totalItems += item.qty; });
  const finalTotal = getFinalPrice(totalBase);
  document.getElementById('mlc-summary-items').textContent = totalItems;
  document.getElementById('mlc-summary-total').textContent = finalTotal.text;
  resetMlcModalState();
  toggleMlcModal(true);
};

window.toggleMlcModal = (open) => {
  document.getElementById('mlc-overlay').classList.toggle('active', open);
  if(open) setTimeout(() => lucide.createIcons(), 100);
};

function resetMlcModalState() {
  mlcReceiptFile = null;
  document.getElementById('mlc-preview-container').style.display = 'none';
  document.getElementById('mlc-upload-progress').style.display = 'none';
  document.getElementById('confirm-mlc-btn').disabled = true;
  document.getElementById('mlc-receipt-file').value = '';
}

window.handleMlcReceiptFileInput = (event) => {
  const file = event.target.files[0];
  if (!file) return;
  mlcReceiptFile = file;
  document.getElementById('mlc-preview').src = URL.createObjectURL(file);
  document.getElementById('mlc-preview-container').style.display = 'block';
  document.getElementById('confirm-mlc-btn').disabled = false;
  lucide.createIcons();
};

window.removeMlcReceiptPreview = () => { resetMlcModalState(); };

window.confirmMlcPayment = async () => {
  if (!mlcReceiptFile) return;

  const btn = document.getElementById('confirm-mlc-btn');
  const loader = document.getElementById('mlc-upload-progress');
  btn.disabled = true;
  loader.style.display = 'block';

  try {
    const orderId = `CS-MLC-${Date.now().toString().slice(-6)}`;
    const uploadedUrl = await uploadReceiptToSupabase(mlcReceiptFile, orderId);
    
    // Capturamos los datos del formulario incluyendo la Referencia
    const name = document.getElementById('order-name').value.trim();
    const phone = document.getElementById('order-phone').value.trim();
    const addr = document.getElementById('order-address').value.trim();
    const ref = document.getElementById('order-reference').value.trim(); // <--- Referencia

    let totalBase = 0;
    const itemsList = cart.map(item => {
      totalBase += (parseFloat(item.price) * item.qty);
      return `‚Ä¢ *${item.qty}x* ${item.name}`;
    }).join('\n');
    
    const finalTotal = getFinalPrice(totalBase);

    await createOrderInSupabase({
      order_id: orderId,
      customer_name: name,
      phone: phone,
      address: addr,
      reference: ref,
      items: cart,
      total_text: finalTotal.text,
      payment_method: 'MLC',
      receipt_url: uploadedUrl,
      status: 'pending'
    });

    // CONSTRUCCI√ìN DEL MENSAJE CORREGIDA (Incluyendo Referencia)
    const text = encodeURIComponent(
      `üëë *NUEVO PAGO MLC*\nPedido: #${orderId}\n\n` +
      `üë§ *Cliente:* ${name}\n` +
      `üìç *Direcci√≥n:* ${addr}\n` +
      (ref ? `üè† *Referencia:* ${ref}\n` : '') + // <--- Se a√±ade esta l√≠nea al mensaje
      `üìû *Tel:* +53${phone}\n` +
      `üì∏ *Comprobante:* ${uploadedUrl}\n\n` +
      `üõçÔ∏è *PRODUCTOS:*\n${itemsList}\n\n` +
      `üí∞ *TOTAL:* ${finalTotal.text}`
    );

    setTimeout(() => { window.location.href = `https://wa.me/+5353910527?text=${text}`; }, 100);

    // Limpieza total
    cart = [];
    clearOrderForm(); // <--- Limpia el formulario (Nombre, Dir, Ref, Tel)
    saveCartToStorage();
    updateCartUI();
    toggleMlcModal(false);
    toggleCart(false); // <--- Cierra el carrito tambi√©n
  } catch (e) {
    console.error(e);
    alert("Error al enviar el pago");
    btn.disabled = false;
    loader.style.display = 'none';
  }
};

window.openTraModal = () => {
  toggleCart(false);
  let totalBase = 0, totalItems = 0;
  cart.forEach(item => { totalBase += (parseFloat(item.price) * item.qty); totalItems += item.qty; });
  const finalTotal = getFinalPrice(totalBase);
  document.getElementById('tra-summary-items').textContent = totalItems;
  document.getElementById('tra-summary-total').textContent = finalTotal.text;
  resetTraModalState();
  toggleTraModal(true);
};

window.toggleTraModal = (open) => {
  document.getElementById('tra-overlay').classList.toggle('active', open);
  if(open) setTimeout(() => lucide.createIcons(), 100);
};

function resetTraModalState() {
  traReceiptFile = null;
  document.getElementById('tra-preview-container').style.display = 'none';
  document.getElementById('tra-upload-progress').style.display = 'none';
  document.getElementById('confirm-tra-btn').disabled = true;
  document.getElementById('tra-receipt-file').value = '';
}

window.handleTraReceiptFileInput = (event) => {
  const file = event.target.files[0];
  if (!file) return;
  traReceiptFile = file;
  document.getElementById('tra-preview').src = URL.createObjectURL(file);
  document.getElementById('tra-preview-container').style.display = 'block';
  document.getElementById('confirm-tra-btn').disabled = false;
  lucide.createIcons();
};

window.removeTraReceiptPreview = () => { resetTraModalState(); };

window.confirmTraPayment = async () => {
  if (!traReceiptFile) {
    showTopError("Falta el comprobante de transferencia");
    return;
  }

  const btn = document.getElementById('confirm-tra-btn');
  const loader = document.getElementById('tra-upload-progress');
  const errorMsg = document.getElementById('tra-file-error');

  btn.disabled = true;
  loader.style.display = 'block';
  errorMsg.style.display = 'none';

  try {
    // 1. Generar ID √∫nico para la transferencia
    const orderId = `CS-TR-${Date.now().toString().slice(-6)}`;
    
    // 2. Subir imagen a Supabase
    const uploadedUrl = await uploadReceiptToSupabase(traReceiptFile, orderId);
    
    // 3. Capturar datos del formulario
    const name = document.getElementById('order-name').value.trim();
    const phone = document.getElementById('order-phone').value.trim();
    const addr = document.getElementById('order-address').value.trim();
    const ref = document.getElementById('order-reference').value.trim();

    // 4. Calcular totales y lista de productos
    let totalBase = 0;
    const itemsList = cart.map(item => {
      totalBase += (parseFloat(item.price) * item.qty);
      const pObj = getFinalPrice(item.price); // Obtiene el precio formateado seg√∫n moneda
      return `‚Ä¢ *${item.qty}x* ${item.name} _(${pObj.text})_`;
    }).join('\n');
    
    const finalTotal = getFinalPrice(totalBase);

    // 5. Registrar pedido en la base de datos
    await createOrderInSupabase({
      order_id: orderId,
      customer_name: name,
      phone: phone,
      address: addr,
      reference: ref,
      items: cart,
      total_text: finalTotal.text,
      payment_method: 'Transferencia',
      receipt_url: uploadedUrl,
      status: 'pending'
    });

    // 6. Estructura de WhatsApp id√©ntica a Zelle
    const text = encodeURIComponent(
      `üëë *NUEVA TRANSFERENCIA*\nPedido: #${orderId}\n\n` +
      `üë§ *Cliente:* ${name}\n` +
      `üìç *Direcci√≥n:* ${addr}\n` +
      (ref ? `üè† *Ref:* ${ref}\n` : '') +
      `üìû *Tel:* +53${phone}\n` +
      `üì∏ *Comprobante:* ${uploadedUrl}\n\n` +
      `üõçÔ∏è *PRODUCTOS:*\n${itemsList}\n\n` +
      `üí∞ *TOTAL:* ${finalTotal.text}`
    );

    // 7. Redirecci√≥n a WhatsApp
    setTimeout(() => {
      window.location.href = `https://wa.me/+5353910527?text=${text}`;
    }, 100);

    // Limpiar carrito y cerrar modales
    cart = [];
    clearOrderForm();
    saveCartToStorage();
    updateCartUI();
    toggleTraModal(false);
    toggleCart(false);

  } catch (e) {
    console.error('Error en transferencia:', e);
    errorMsg.textContent = "Error al procesar el pago. Reintente.";
    errorMsg.style.display = 'block';
    btn.disabled = false;
    loader.style.display = 'none';
  }
};


// Modificar la funci√≥n sendOrder existente para incluir flujo Zelle
window.sendOrder = () => {
  const nameInput = document.getElementById('order-name');
  const addrInput = document.getElementById('order-address');
  const refInput = document.getElementById('order-reference');
  const phoneInput = document.getElementById('order-phone');

  const name = nameInput.value.trim();
  const addr = addrInput.value.trim();
  const ref = refInput.value.trim();
  const phone = phoneInput.value.trim();

  if (cart.length === 0) { showTopError("El carrito est√° vac√≠o"); return; }
  
  let hasError = false;
  if (name.length < 3) { nameInput.classList.add('invalid'); hasError = true; }
  if (addr.length < 5) { addrInput.classList.add('invalid'); hasError = true; }
  if (!/^5\d{7}$/.test(phone)) { phoneInput.classList.add('invalid'); hasError = true; }

  if (hasError) { showTopError("Revisa los datos marcados"); return; }

  // Si el m√©todo de pago es Zelle, abrir modal en lugar de enviar directamente
  if (currentPaymentMethodCode === 'Z') {
    openZelleModal();
    return;
  }

   if (currentPaymentMethodCode === 'Tra') {
    openTraModal();
    return;
  }

  if (currentPaymentMethodCode === 'mlc') {
    openMlcModal();
    return;
  }

  // Flujo normal para otros m√©todos de pago (copiar c√≥digo existente aqu√≠)
  let totalBase = 0;
  const itemsList = cart.map(item => {
    totalBase += (parseFloat(item.price) * item.qty);
    const pObj = getFinalPrice(item.price);
    return `‚Ä¢ *${item.qty}x* ${item.name} _(${pObj.text})_`;
  }).join('\n');

  const finalTotalObj = getFinalPrice(totalBase);
  const text = encodeURIComponent(
    `üëë *NUEVO PEDIDO | CUBAN STORE*\n\n` +
    `üë§ *Cliente:* ${name}\n` +
    `üìç *Direcci√≥n:* ${addr}\n` +
    (ref ? `üè† *Referencia:* ${ref}\n` : '') +
    `üìû *Tel√©fono:* +53${phone}\n` +
    `üí≥ *M√©todo de Pago:* ${finalTotalObj.methodName}\n\n` +
    `üõçÔ∏è *PRODUCTOS:*\n${itemsList}\n\n` +
    `üí∞ *TOTAL A PAGAR:* ${finalTotalObj.text}\n\n` +
    `‚úÖ _Espere su confirmaci√≥n, gracias..._`
  );

  window.open(`https://wa.me/+5353910527?text=${text}`, '_blank');
  
  cart = [];
  document.querySelectorAll('#order-form input').forEach(i => { i.value = ''; i.classList.remove('invalid'); });
  saveCartToStorage();
  updateCartUI();
  toggleCart(false);
  showToast("¬°Pedido enviado!");
};

function clearOrderForm() {
  const inputs = document.querySelectorAll('#order-form input');
  inputs.forEach(i => {
    i.value = '';
    i.classList.remove('invalid');
  });
}

// Iniciar app
init();
</script>
</body>
</html>
