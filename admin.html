<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Pro Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Google Fonts: Inter para un look moderno -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6366f1; /* Indigo moderno */
      --primary-hover: #4f46e5;
      --bg-gradient: radial-gradient(circle at top left, #1e1b4b, #0f172a);
      --glass-bg: rgba(30, 41, 59, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --success: #10b981;
      --danger: #f43f5e;
      --warning: #f59e0b;
      --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }

    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      font-family: 'Inter', sans-serif; 
    }

    body { 
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main); 
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* HEADER */
    header {
      margin-bottom: 40px;
      text-align: center;
      animation: fadeInDown 0.8s ease;
    }

    header h1 {
      font-size: 2.5rem;
      font-weight: 800;
      letter-spacing: -0.025em;
      background: linear-gradient(to right, #fff, #94a3b8);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* GRID DE ACCESO R√ÅPIDO */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 30px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-align: center;
      box-shadow: var(--card-shadow);
    }

    .stat-card:hover {
      transform: translateY(-10px);
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary);
    }

    .stat-card .icon {
      font-size: 2.5rem;
      margin-bottom: 15px;
      display: block;
    }

    .stat-card h3 {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-main);
    }

    /* MODALES ESTILO CRISTAL */
    .modal-overlay { 
      position: fixed; 
      top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center; 
      z-index: 1000; opacity: 0; pointer-events: none; 
      transition: all 0.4s ease;
    }
    
    .modal-overlay.active { opacity: 1; pointer-events: all; }

    .modal-content { 
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      padding: 35px; 
      border-radius: 32px; 
      max-width: 900px; 
      width: 95%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      transform: scale(0.9);
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .modal-overlay.active .modal-content { transform: scale(1); }

    /* FORMULARIOS MODERNOS */
    .form-row { 
      background: rgba(255, 255, 255, 0.03);
      padding: 25px; 
      border-radius: 20px; 
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
    }

    .form-field label { 
      display: block;
      font-size: 0.75rem; 
      color: var(--text-muted); 
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    input, select { 
      width: 100%; 
      padding: 14px 18px; 
      background: rgba(15, 23, 42, 0.6); 
      color: white; 
      border: 1px solid var(--glass-border); 
      border-radius: 12px; 
      outline: none; 
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    input:focus { 
      border-color: var(--primary); 
      background: rgba(15, 23, 42, 0.9);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
    }

    /* BOTONES */
    .btn { 
      padding: 12px 24px; 
      border-radius: 12px; 
      cursor: pointer; 
      border: none; 
      font-weight: 600; 
      font-size: 0.9rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 10px;
    }

    .btn:active { transform: scale(0.95); }
    
    .btn-add { background: var(--primary); color: white; }
    .btn-add:hover { background: var(--primary-hover); box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4); }

    .btn-delete { background: rgba(244, 63, 94, 0.1); color: var(--danger); border: 1px solid rgba(244, 63, 94, 0.2); }
    .btn-delete:hover { background: var(--danger); color: white; }

    .btn-edit { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
    .btn-edit:hover { background: var(--warning); color: white; }
     
     /* Estilo para productos desactivados */
.list-item.is-inactive {
  opacity: 0.6;
  filter: grayscale(0.5);
  border-style: dashed;
}

.btn-toggle-on { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
.btn-toggle-off { background: rgba(244, 63, 94, 0.1); color: var(--danger); border: 1px solid var(--danger); }

    /* LISTADO DE ITEMS */
    .list-item { 
      background: rgba(255, 255, 255, 0.02); 
      border: 1px solid var(--glass-border); 
      border-radius: 16px; 
      padding: 15px 20px; 
      margin-bottom: 12px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between;
      transition: all 0.3s;
    }

    .list-item:hover { background: rgba(255, 255, 255, 0.05); transform: scale(1.01); }

    .item-info { display: flex; align-items: center; gap: 15px; }
    .item-img { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: #000; }

    /* BADGES */
    .status-badge {
      padding: 6px 12px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
    }
    .bg-on { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .bg-off { background: rgba(244, 63, 94, 0.1); color: var(--danger); }

    /* REPORTE DE PEDIDOS */
    .order-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 15px;
      border: 1px solid var(--glass-border);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .order-total {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--success);
    }

    /* TOASTS */
    #toast-container { position: fixed; bottom: 30px; right: 30px; z-index: 2000; }
    .toast { 
      background: var(--glass-bg); 
      backdrop-filter: blur(10px); 
      border-left: 4px solid var(--primary);
      padding: 16px 24px; 
      border-radius: 12px; 
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
      margin-top: 10px;
      animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes fadeInDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

    /* Scrollbar Personalizado */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

    .hidden { display: none !important; }

/* Bot√≥n de Peligro Estilo Glassmorphism */
.btn-danger-glass {
  background: rgba(244, 63, 94, 0.1); /* Rojo suave transparente */
  color: #fb7185; /* Rosa/Rojo brillante */
  border: 1px solid rgba(244, 63, 94, 0.3);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  padding: 10px 20px;
  border-radius: 12px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.btn-danger-glass:hover {
  background: rgba(244, 63, 94, 0.25);
  border-color: rgba(244, 63, 94, 0.6);
  color: #ffffff;
  box-shadow: 0 0 20px rgba(244, 63, 94, 0.2);
  transform: translateY(-1px);
}

.btn-danger-glass:active {
  transform: scale(0.95);
}

/* Ajuste adicional para que el header del modal se vea m√°s limpio */
.modal-header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}
  </style>
</head>
<body>

  <div class="container">
    <header>
      <h1>Admin Dashboard</h1>
      <p style="color: var(--text-muted); margin-top: 10px;">Gesti√≥n profesional de tienda y productos</p>
    </header>

    <div class="dashboard-grid">
      <div class="stat-card" onclick="openModal('modal-payments')">
        <span class="icon">üí≥</span>
        <h3>Monedas y Tasas</h3>
        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">Configura m√©todos de pago</p>
      </div>

      <div class="stat-card" onclick="openModal('modal-store')">
        <span class="icon">üè™</span>
        <h3>Mi Tienda</h3>
        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">Categor√≠as y Productos</p>
      </div>

      <div class="stat-card" onclick="openModal('modal-orders')">
        <span class="icon">üìä</span>
        <h3>Reporte de Ventas</h3>
        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 8px;">An√°lisis de pedidos</p>
      </div>
    </div>
  </div>

  <!-- MODAL M√âTODOS DE PAGO -->
  <div id="modal-payments" class="modal-overlay">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
        <h2>üí≥ Pagos y Tasas</h2>
        <button class="btn btn-delete" style="padding: 5px 15px;" onclick="closeModal('modal-payments')">Cerrar</button>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label>Nombre del M√©todo</label>
          <input id="pay-name" placeholder="Ej: Zelle / Pago M√≥vil">
        </div>
        <div class="form-field">
          <label>C√°lculo</label>
          <select id="pay-mode">
            <option value="none">Precio Base</option>
            <option value="percent">Porcentaje (+ %)</option>
            <option value="divide">Tasa Cambio (/)</option>
          </select>
        </div>
        <div class="form-field">
          <label>Valor</label>
          <input id="pay-value" type="number" step="0.01" value="0">
        </div>
        <button class="btn btn-add" style="height: 48px; align-self: flex-end;" onclick="handleAddPayment()">‚ûï A√±adir</button>
      </div>
      <ul id="payments-list"></ul>
    </div>
  </div>

  <!-- MODAL TIENDA -->
  <div id="modal-store" class="modal-overlay">
    <div class="modal-content">
      <div style="display: flex; justify-content: space-between; margin-bottom: 30px;">
        <h2 id="store-title">üè™ Mi Inventario</h2>
        <button class="btn btn-delete" style="padding: 5px 15px;" onclick="closeModal('modal-store')">Cerrar</button>
      </div>

      <div id="section-categories">
        <div class="form-row">
          <div class="form-field">
            <label>Nueva Categor√≠a</label>
            <input id="new-cat-name" placeholder="Ej: Pizzas / Bebidas">
          </div>
          <div class="form-field">
            <label>Portada (Imagen)</label>
            <input type="file" id="new-cat-img" accept="image/*" style="font-size: 10px;">
          </div>
          <button class="btn btn-add" style="height: 48px; align-self: flex-end;" onclick="handleAddCategory()">‚ûï Crear</button>
        </div>
        <ul id="categories-list"></ul>
      </div>

      <div id="section-products" class="hidden">
        <button class="btn" style="background: rgba(255,255,255,0.1); color: white; margin-bottom: 20px;" onclick="showMainPanel()">‚¨Ö Volver</button>
        <h3 id="current-cat-title" style="margin-bottom: 20px;"></h3>
        <div class="form-row">
          <div class="form-field">
            <label>Producto</label>
            <input id="new-prod-name" placeholder="Nombre">
          </div>
          <div class="form-field">
            <label>Precio $</label>
            <input id="new-prod-price" type="number" step="0.01">
          </div>
          <div class="form-field">
            <label>Foto</label>
            <input type="file" id="new-prod-img" accept="image/*" style="font-size: 10px;">
          </div>
          <button class="btn btn-add" style="height: 48px; align-self: flex-end;" onclick="handleAddProduct()">‚ûï A√±adir</button>
        </div>
        <ul id="products-list"></ul>
      </div>
    </div>
  </div>

  <!-- MODAL REPORTES -->
<div id="modal-orders" class="modal-overlay">
  <div class="modal-content">
    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px;">
      <div>
        <h2 style="margin:0;">üìä Reporte Hist√≥rico</h2>
        <p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 4px;">Gesti√≥n de base de datos y archivos</p>
      </div>
      
      <div class="modal-header-actions">
        <!-- BOT√ìN CON LA NUEVA CLASE -->
        <button class="btn-danger-glass" onclick="handleClearAllOrders()">
          <span style="font-size: 1.1rem;">üóëÔ∏è</span>
          Vaciar Historial
        </button>
        
        <button class="btn" style="background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--glass-border);" onclick="closeModal('modal-orders')">
          Cerrar
        </button>
      </div>
    </div>
    
    <!-- Stats Grid (Se mantiene igual) -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="padding: 20px; background: rgba(16, 185, 129, 0.05);">
          <small style="color: var(--text-muted);">Ventas Totales</small>
          <div id="total-revenue" style="font-size: 1.8rem; font-weight: 800; color: var(--success);">$0.00</div>
        </div>
        <div class="stat-card" style="padding: 20px;">
          <small style="color: var(--text-muted);">Pedidos Realizados</small>
          <div id="total-orders-count" style="font-size: 1.8rem; font-weight: 800;">0</div>
        </div>
    </div>

    <div id="orders-detailed-list">
       <!-- Lista de pedidos -->
    </div>
  </div>
</div>

  <div id="toast-container"></div>

  <!-- MODAL CONFIRMACI√ìN -->
  <div id="modal-confirm" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <h3 id="modal-title">¬øConfirmar acci√≥n?</h3>
      <p id="modal-text" style="color: var(--text-muted); margin: 15px 0 25px;">Esta acci√≥n no se puede revertir.</p>
      <div style="display: flex; gap: 10px; justify-content: center;">
        <button class="btn" style="background: rgba(255,255,255,0.1); color: white;" onclick="closeConfirm(false)">Cancelar</button>
        <button class="btn btn-delete" onclick="closeConfirm(true)">Si, eliminar</button>
      </div>
    </div>
  </div>
<!-- MODAL EDITAR PRODUCTO -->
<div id="modal-edit-product" class="modal-overlay">
  <div class="modal-content" style="max-width: 500px;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
      <h2>‚úèÔ∏è Editar Producto</h2>
      <button class="btn btn-delete" style="padding: 5px 15px;" onclick="closeModal('modal-edit-product')">Cerrar</button>
    </div>
    
    <div class="form-field" style="margin-bottom: 15px;">
      <label>Nombre del Producto</label>
      <input id="edit-prod-name">
    </div>
    <div class="form-field" style="margin-bottom: 15px;">
      <label>Precio $</label>
      <input id="edit-prod-price" type="number" step="0.01">
    </div>
    <div class="form-field" style="margin-bottom: 25px;">
      <label>Nueva Imagen (Opcional)</label>
      <input type="file" id="edit-prod-img" accept="image/*" style="font-size: 10px;">
    </div>
    
    <input type="hidden" id="edit-prod-id">
    
    <button class="btn btn-add" style="width: 100%;" onclick="handleUpdateProduct()">üíæ Guardar Cambios</button>
  </div>
</div>

  <script type="module">
    // Mantenemos tu l√≥gica original de script
    import * as api from './api.js';

    let allProducts = [];
    let allCategories = [];
    let allPayments = [];
    let currentCategoryId = null;
    let editingId = null;
    let confirmResolver = null;

    // --- FUNCIONES DE MODALES ---
    window.openModal = (modalId) => {
      document.getElementById(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
      if (modalId === 'modal-store') { refreshData(); showMainPanel(); }
      if (modalId === 'modal-payments') { refreshData(); }
      if (modalId === 'modal-orders') { loadOrdersSummary(); }
    };

    window.closeModal = (modalId) => {
      document.getElementById(modalId).classList.remove('active');
      document.body.style.overflow = 'auto';
    };

    // --- UTILIDADES ---
    window.showToast = (msg, type = 'info') => {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast`;
      if(type === 'error') toast.style.borderLeftColor = 'var(--danger)';
      toast.innerText = msg;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    };

    window.customConfirm = (title, text) => {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-text').innerText = text;
      document.getElementById('modal-confirm').classList.add('active');
      return new Promise(resolve => { confirmResolver = resolve; });
    };

    window.closeConfirm = (val) => {
      document.getElementById('modal-confirm').classList.remove('active');
      if(confirmResolver) confirmResolver(val);
    };

    // --- REFRESH DATA (Mantenido) ---
    async function refreshData() {
      try {
        const [categories, products, payments] = await Promise.all([
            api.getCategories(), 
            api.getAllProducts(),
            api.getPaymentMethods()
        ]);
        allCategories = categories;
        allProducts = products;
        allPayments = payments;
        renderCategories();
        renderPaymentMethods();
        if (currentCategoryId) renderProducts();
      } catch (e) { showToast("Error de conexi√≥n", "error"); }
    }

    // --- RENDERS CON EL NUEVO ESTILO ---
    function renderPaymentMethods() {
      const list = document.getElementById('payments-list');
      list.innerHTML = allPayments.map(pay => `
        <li class="list-item">
          <div class="item-info">
            <div>
              <p style="font-weight:700;">${pay.name}</p>
              <small style="color:var(--text-muted)">Modo: ${pay.mode} | Valor: ${pay.value}</small>
            </div>
          </div>
          <div style="display:flex; gap:10px;">
             <span class="status-badge ${pay.active ? 'bg-on' : 'bg-off'}">${pay.active ? 'Activo' : 'Off'}</span>
             <button class="btn btn-edit" style="padding:5px 10px" onclick="startEdit('${pay.id}')">‚úèÔ∏è</button>
             <button class="btn btn-delete" style="padding:5px 10px" onclick="handleDeletePayment('${pay.id}')">üóëÔ∏è</button>
          </div>
        </li>
      `).join('');
    }

    function renderCategories() {
      const list = document.getElementById('categories-list');
      list.innerHTML = allCategories.map(cat => `
        <li class="list-item">
          <div class="item-info">
            <img class="item-img" src="${cat.image_url || 'https://via.placeholder.com/50'}">
            <p style="font-weight:700;">${cat.name}</p>
          </div>
          <div style="display:flex; gap:10px;">
            <button class="btn" style="background:var(--primary); color:white; font-size:12px;" onclick="showCategoryProducts('${cat.id}', '${cat.name}')">Ver Productos</button>
            <button class="btn btn-delete" onclick="handleDeleteCategory('${cat.id}')">üóëÔ∏è</button>
          </div>
        </li>
      `).join('');
    }

    // --- NUEVO RENDER DE PRODUCTOS ---
function renderProducts() {
  const list = document.getElementById('products-list');
  // Filtramos por categor√≠a pero MOSTRARMOS todos (activos e inactivos)
  const filtered = allProducts.filter(p => String(p.category_id) === String(currentCategoryId));
  
  list.innerHTML = filtered.map(p => `
    <li class="list-item ${!p.active ? 'is-inactive' : ''}">
      <div class="item-info">
        <img class="item-img" src="${p.image_url || 'https://via.placeholder.com/50'}" onerror="this.src='https://via.placeholder.com/50'">
        <div>
          <p style="font-weight:700;">${p.name}</p>
          <p style="color:var(--success); font-weight:700;">$${p.price}</p>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <!-- Bot√≥n Switch Activar/Desactivar -->
        <button class="btn ${p.active ? 'btn-toggle-on' : 'btn-toggle-off'}" 
                onclick="handleToggleProductStatus('${p.id}', ${p.active})" 
                title="${p.active ? 'Desactivar' : 'Activar'}">
          ${p.active ? 'Visible' : 'Oculto'}
        </button>
        
        <!-- Bot√≥n Editar -->
        <button class="btn btn-edit" onclick="openEditProduct('${p.id}')">‚úèÔ∏è</button>
        
        <!-- Bot√≥n Eliminar -->
        <button class="btn btn-delete" onclick="handleDeleteProduct('${p.id}')">üóëÔ∏è</button>
      </div>
    </li>
  `).join('');
}

// --- L√ìGICA DE ACTIVACI√ìN/DESACTIVACI√ìN ---
window.handleToggleProductStatus = async (id, currentStatus) => {
    try {
        await api.updateProduct(id, { active: !currentStatus });
        showToast(currentStatus ? "Producto ocultado" : "Producto visible");
        refreshData();
    } catch (e) {
        showToast("Error al cambiar estado", "error");
    }
};

// --- L√ìGICA DE EDICI√ìN ---
window.openEditProduct = (id) => {
    const prod = allProducts.find(p => String(p.id) === String(id));
    if (!prod) return;

    document.getElementById('edit-prod-id').value = prod.id;
    document.getElementById('edit-prod-name').value = prod.name;
    document.getElementById('edit-prod-price').value = prod.price;
    document.getElementById('edit-prod-img').value = ""; // Limpiar input file
    
    openModal('modal-edit-product');
};

window.handleUpdateProduct = async () => {
    const id = document.getElementById('edit-prod-id').value;
    const name = document.getElementById('edit-prod-name').value;
    const price = document.getElementById('edit-prod-price').value;
    const file = document.getElementById('edit-prod-img').files[0];

    if (!name || !price) return showToast("Nombre y precio son obligatorios", "error");

    try {
        let updateData = {
            name: name,
            price: parseFloat(price)
        };

        // Si el usuario subi√≥ una nueva foto, la procesamos
        if (file) {
            showToast("Subiendo nueva imagen...");
            const newUrl = await api.uploadImage('products', file);
            updateData.image_url = newUrl;
        }

        await api.updateProduct(id, updateData);
        
        closeModal('modal-edit-product');
        showToast("Producto actualizado con √©xito", "success");
        refreshData();
    } catch (e) {
        console.error(e);
        showToast("Error al actualizar", "error");
    }
};

    // --- ACCIONES LOGICAS (Llamadas a tu api.js) ---
    window.handleAddPayment = async () => {
        const name = document.getElementById('pay-name').value;
        const mode = document.getElementById('pay-mode').value;
        const value = document.getElementById('pay-value').value;
        if(!name) return showToast("Nombre requerido", "error");
        await api.createPaymentMethod({ name, code: name.toLowerCase().replace(" ", ""), mode, value: parseFloat(value), active: true });
        refreshData();
        showToast("M√©todo a√±adido");
    };

    window.handleAddCategory = async () => {
        const input = document.getElementById('new-cat-name');
        const file = document.getElementById('new-cat-img').files[0];
        if(!input.value) return showToast("Nombre requerido", "error");
        let url = file ? await api.uploadImage('categories', file) : null;
        await api.createCategory(input.value, url);
        refreshData();
        input.value = "";
        showToast("Categor√≠a creada");
    };

    window.handleAddProduct = async () => {
        const nameInp = document.getElementById('new-prod-name');
        const priceInp = document.getElementById('new-prod-price');
        const file = document.getElementById('new-prod-img').files[0];
        if(!nameInp.value || !priceInp.value) return showToast("Datos incompletos", "error");
        let url = file ? await api.uploadImage('products', file) : null;
        await api.createProduct({ name: nameInp.value, price: parseFloat(priceInp.value), image_url: url, category_id: currentCategoryId });
        refreshData();
        nameInp.value = ""; priceInp.value = "";
        showToast("Producto a√±adido");
    };

    window.handleDeleteCategory = async (id) => {
        if(await customConfirm("¬øEliminar?", "Se borrar√°n todos sus productos.")) {
            await api.deleteCategory(id);
            refreshData();
        }
    };

    window.handleDeleteProduct = async (id) => {
        if(await customConfirm("¬øBorrar producto?", "")) {
            await api.deleteProduct(id);
            refreshData();
        }
    };

    window.showCategoryProducts = (id, name) => {
        currentCategoryId = id;
        document.getElementById('section-categories').classList.add('hidden');
        document.getElementById('section-products').classList.remove('hidden');
        document.getElementById('current-cat-title').innerText = `üì¶ ${name}`;
        renderProducts();
    };

    window.showMainPanel = () => {
        document.getElementById('section-products').classList.add('hidden');
        document.getElementById('section-categories').classList.remove('hidden');
    };

    window.loadOrdersSummary = async () => {
        const container = document.getElementById('orders-detailed-list');
        const orders = await api.getOrders();
        let totalRev = 0;
        
        container.innerHTML = orders.map(order => {
            const price = parseFloat(String(order.total_text).replace(/[^0-9.-]+/g,"")) || 0;
            totalRev += price;
            return `
                <div class="order-card">
                    <div class="order-header">
                        <span style="color:var(--text-muted)">#${String(order.id).slice(-5)}</span>
                        <span class="order-total">$${price.toFixed(2)}</span>
                    </div>
                    <p>üë§ <strong>${order.customer_name || 'Cliente'}</strong></p>
                    <p style="font-size:0.8rem; color:var(--text-muted)">üí≥ ${order.payment_method}</p>
                </div>
            `;
        }).join('');
        
        document.getElementById('total-revenue').innerText = `$${totalRev.toFixed(2)}`;
        document.getElementById('total-orders-count').innerText = orders.length;
    };

window.handleClearAllOrders = async () => {
    const confirm = await customConfirm(
        "¬øELIMINAR TODO EL HISTORIAL?", 
        "Se borrar√°n todos los pedidos de la base de datos y todas las im√°genes de la carpeta 'comprobantes/orders'. Esta acci√≥n es irreversible."
    );

    if (!confirm) return;

    try {
        showToast("Iniciando limpieza profunda...");
        
        await api.deleteAllOrdersData();
        
        showToast("Historial y Storage limpiados", "success");
        
        // Actualizar la interfaz manualmente para que aparezca vac√≠a
        document.getElementById('orders-detailed-list').innerHTML = "<p style='text-align:center; padding:20px; color:gray;'>No hay pedidos registrados.</p>";
        document.getElementById('total-revenue').innerText = "$0.00";
        document.getElementById('total-orders-count').innerText = "0";
        
    } catch (e) {
        console.error("Error al limpiar:", e);
        showToast("Error al eliminar archivos o datos", "error");
    }
};

    refreshData();
  </script>
</body>
</html>